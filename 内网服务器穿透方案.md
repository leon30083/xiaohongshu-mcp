# 基于Linux ARM64服务器的内网穿透方案

## 🏗️ 网络架构

```
Internet
    ↓
主路由器 (公网IP + 端口映射)
    ↓
子路由器 (192.168.x.x)
    ├── Windows PC (本机) - xiaohongshu-mcp:8080
    ├── Linux ARM64 服务器 (代理服务器)
    └── 其他设备
```

## 🎯 方案1：Nginx反向代理（推荐）

### 优势
- ✅ 高稳定性，完全内网控制
- ✅ 支持负载均衡和健康检查
- ✅ 可配置SSL证书
- ✅ 详细的访问日志
- ✅ 支持多服务代理

### Linux服务器配置

#### 1. 安装Nginx
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install nginx

# CentOS/RHEL
sudo yum install nginx
# 或
sudo dnf install nginx
```

#### 2. 配置Nginx反向代理
```bash
sudo nano /etc/nginx/sites-available/xiaohongshu-mcp
```

```nginx
server {
    listen 8080;
    server_name _;
    
    # 健康检查端点
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
    
    # MCP代理
    location /mcp {
        proxy_pass http://WINDOWS_PC_IP:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket支持
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # 根路径重定向
    location / {
        proxy_pass http://WINDOWS_PC_IP:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

#### 3. 启用配置
```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/xiaohongshu-mcp /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启Nginx
sudo systemctl restart nginx
sudo systemctl enable nginx
```

### 路由器配置

#### 主路由器端口映射
```
外网端口: 18080
内网IP: Linux服务器IP
内网端口: 8080
协议: TCP
```

### Windows PC配置

确保MCP代理服务器正常运行：
```powershell
# 检查服务状态
netstat -an | findstr :8080

# 启动服务
node mcp-proxy-server.js
```

## 🎯 方案2：SSH隧道

### 优势
- ✅ 加密传输，安全性高
- ✅ 无需额外软件
- ✅ 配置简单

### Linux服务器配置

#### 1. 确保SSH服务运行
```bash
sudo systemctl status ssh
sudo systemctl enable ssh
```

#### 2. 配置SSH
```bash
sudo nano /etc/ssh/sshd_config
```

添加或修改：
```
GatewayPorts yes
AllowTcpForwarding yes
```

重启SSH服务：
```bash
sudo systemctl restart ssh
```

### Windows PC配置

#### 1. 安装OpenSSH客户端
```powershell
# Windows 10/11 通常已预装
ssh -V
```

#### 2. 创建SSH隧道
```powershell
# 创建反向隧道
ssh -R 8080:localhost:8080 user@LINUX_SERVER_IP

# 或者创建持久化隧道
ssh -R 8080:localhost:8080 -N -f user@LINUX_SERVER_IP
```

#### 3. 自动化脚本
```powershell
# ssh-tunnel.ps1
$LinuxServerIP = "192.168.x.x"  # 替换为实际IP
$Username = "your_username"     # 替换为实际用户名

Write-Host "Creating SSH tunnel to $LinuxServerIP..."
ssh -R 8080:localhost:8080 -N -o ServerAliveInterval=60 -o ServerAliveCountMax=3 $Username@$LinuxServerIP
```

## 🎯 方案3：FRP内网穿透

### 优势
- ✅ 专业的内网穿透工具
- ✅ 支持多种协议
- ✅ 有Web管理界面

### Linux服务器配置（FRP服务端）

#### 1. 下载FRP
```bash
# 下载ARM64版本
wget https://github.com/fatedier/frp/releases/download/v0.52.3/frp_0.52.3_linux_arm64.tar.gz
tar -xzf frp_0.52.3_linux_arm64.tar.gz
cd frp_0.52.3_linux_arm64
```

#### 2. 配置frps.ini
```ini
[common]
bind_port = 7000
dashboard_port = 7500
dashboard_user = admin
dashboard_pwd = your_password
token = your_secret_token

# 允许的端口范围
allow_ports = 8080-8090
```

#### 3. 启动FRP服务端
```bash
./frps -c frps.ini

# 或创建systemd服务
sudo cp frps /usr/local/bin/
sudo nano /etc/systemd/system/frps.service
```

systemd服务配置：
```ini
[Unit]
Description=FRP Server
After=network.target

[Service]
Type=simple
User=frp
ExecStart=/usr/local/bin/frps -c /etc/frp/frps.ini
Restart=on-failure
RestartSec=5s

[Install]
WantedBy=multi-user.target
```

### Windows PC配置（FRP客户端）

#### 1. 下载Windows版FRP
```powershell
# 下载并解压到项目目录
Invoke-WebRequest -Uri "https://github.com/fatedier/frp/releases/download/v0.52.3/frp_0.52.3_windows_amd64.zip" -OutFile "frp.zip"
Expand-Archive -Path "frp.zip" -DestinationPath "."
```

#### 2. 配置frpc.ini
```ini
[common]
server_addr = LINUX_SERVER_IP
server_port = 7000
token = your_secret_token

[xiaohongshu-mcp]
type = tcp
local_ip = 127.0.0.1
local_port = 8080
remote_port = 8080
```

#### 3. 启动FRP客户端
```powershell
.\frpc.exe -c frpc.ini
```

## 📊 方案对比

| 方案 | 稳定性 | 安全性 | 配置难度 | 性能 | 推荐度 |
|------|--------|--------|----------|------|--------|
| Nginx反向代理 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ | 🥇 |
| SSH隧道 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | 🥈 |
| FRP | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐ | 🥉 |

## 🚀 实施建议

### 第一步：选择方案
推荐从**Nginx反向代理**开始，因为：
- 配置相对简单
- 性能最好
- 功能最丰富
- 便于后续扩展

### 第二步：网络准备
1. 确认Linux服务器的内网IP地址
2. 确认Windows PC的内网IP地址
3. 测试两台设备之间的网络连通性

### 第三步：逐步实施
1. 先在Linux服务器上配置代理
2. 测试内网访问
3. 配置路由器端口映射
4. 测试外网访问

### 第四步：监控和维护
1. 设置日志监控
2. 配置自动重启
3. 定期检查服务状态

## 🔧 故障排除

### 常见问题
1. **连接超时**：检查防火墙设置
2. **代理失败**：确认目标服务正在运行
3. **端口冲突**：使用netstat检查端口占用

### 调试命令
```bash
# 检查端口监听
sudo netstat -tlnp | grep :8080

# 检查Nginx状态
sudo systemctl status nginx

# 查看Nginx日志
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log

# 测试代理
curl -X POST http://localhost:8080/mcp -H "Content-Type: application/json" -d '{"method":"initialize"}'
```